<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>STOMP 테스트 클라이언트 (SockJS + Heartbeat)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- SockJS + STOMP -->
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { max-width: 920px; margin: 24px auto; padding: 0 16px; }
    h1 { font-size: 20px; margin-bottom: 12px; }
    fieldset { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 16px 0; }
    legend { padding: 0 8px; color: #333; }
    .row { display: grid; grid-template-columns: 180px 1fr auto; gap: 8px; align-items: center; margin: 8px 0; }
    label { color: #333; }
    input[type="text"], input[type="url"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 10px; }
    button { padding: 10px 14px; border: 1px solid #333; background: #111; color: #fff; border-radius: 10px; cursor: pointer; }
    button.ghost { background: #fff; color: #111; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .log { height: 280px; overflow: auto; background: #0b1020; color: #dfe6ff; padding: 12px; border-radius: 12px; font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 12px; }
    .muted { color: #888; font-size: 12px; }
    .columns { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .ok { color: #9be79b; }
    .warn { color: #ffd27a; }
    .err { color: #ff9a9a; }
  </style>
</head>
<body>
  <h1>Spring STOMP × SockJS × Heartbeat 테스트</h1>

  <fieldset>
    <legend>연결</legend>
    <div class="row">
      <label for="wsUrl">SockJS URL</label>
      <!-- SockJS는 ws://가 아니라 http(s):// 사용 -->
      <input id="wsUrl" type="url" value="http://localhost:8080/ws" />
      <button id="btnConnect">연결</button>
    </div>
    <div class="row">
      <label for="hbOut">Heartbeat (ms)</label>
      <input id="hbOut" type="text" placeholder="outgoing,incoming" value="10000,10000" />
      <button id="btnDisconnect" class="ghost" disabled>연결 종료</button>
    </div>
    <div class="row">
      <label for="debugToggle">디버그 로그</label>
      <input id="debugToggle" type="checkbox" />
      <span class="muted">STOMP 내부 로그를 콘솔에 표시</span>
    </div>
  </fieldset>

  <fieldset>
    <legend>구독</legend>
    <div class="row">
      <label for="roomId">Room ID</label>
      <input id="roomId" type="text" placeholder="room-1" value="room-1" />
      <button id="btnSubscribe" disabled>구독 시작</button>
    </div>
    <div class="row">
      <label for="destPreview">Destination 미리보기</label>
      <input id="destPreview" type="text" readonly placeholder="/topic/rooms/room-1" />
      <button id="btnUnsubscribe" class="ghost" disabled>구독 해제</button>
    </div>
  </fieldset>

  <fieldset>
    <legend>메시지 전송</legend>
    <div class="row">
      <label for="senderId">Sender ID</label>
      <input id="senderId" type="text" placeholder="u-123" value="u-123" />
      <button id="btnSend" disabled>전송</button>
    </div>
    <div class="row">
      <label for="content">Content</label>
      <input id="content" type="text" placeholder="메시지 내용을 입력하세요" value="hello" />
      <span class="muted">/app/chat.send 로 전송</span>
    </div>
  </fieldset>

  <div class="columns">
    <fieldset>
      <legend>수신 로그</legend>
      <div id="recv" class="log" aria-live="polite"></div>
    </fieldset>
    <fieldset>
      <legend>이벤트 로그</legend>
      <div id="log" class="log" aria-live="polite"></div>
    </fieldset>
  </div>

  <script>
    // UI 요소
    const $ = (id) => document.getElementById(id);
    const wsUrl = $("wsUrl");
    const hbOut = $("hbOut");
    const debugToggle = $("debugToggle");
    const roomId = $("roomId");
    const destPreview = $("destPreview");
    const senderId = $("senderId");
    const content = $("content");
    const btnConnect = $("btnConnect");
    const btnDisconnect = $("btnDisconnect");
    const btnSubscribe = $("btnSubscribe");
    const btnUnsubscribe = $("btnUnsubscribe");
    const btnSend = $("btnSend");
    const recv = $("recv");
    const log = $("log");

    // 상태
    let stompClient = null;
    let sock = null;
    let subscription = null;

    function addLog(target, msg, cls = "") {
      const time = new Date().toLocaleTimeString();
      const line = document.createElement("div");
      if (cls) line.className = cls;
      line.textContent = `[${time}] ${msg}`;
      target.appendChild(line);
      target.scrollTop = target.scrollHeight;
    }

    function setConnected(connected) {
      btnConnect.disabled = connected;
      btnDisconnect.disabled = !connected;
      btnSubscribe.disabled = !connected;
      btnUnsubscribe.disabled = !connected || !subscription;
      btnSend.disabled = !connected || !subscription;
    }

    function updateDestPreview() {
      const rid = roomId.value.trim() || "room-1";
      destPreview.value = `/topic/rooms/${rid}`;
    }
    updateDestPreview();
    roomId.addEventListener("input", updateDestPreview);

    // 연결
    btnConnect.addEventListener("click", () => {
      const url = (() => {
        const v = (wsUrl.value || "").trim();
        if (v) return v; // SockJS는 http/https URL
        const scheme = location.protocol === "https:" ? "https" : "http";
        return `${scheme}://${location.host}/ws`;
      })();

      const [outMsStr, inMsStr] = (hbOut.value || "10000,10000").split(",").map(s => parseInt(s.trim(), 10));
      const outMs = Number.isFinite(outMsStr) ? outMsStr : 10000; // client -> server
      const inMs  = Number.isFinite(inMsStr)  ? inMsStr  : 10000; // server -> client

      try {
        // SockJS는 ws://가 아니라 http(s)://
        sock = new SockJS(url);
      } catch (e) {
        addLog(log, `SockJS 생성 실패: ${e}`, "err");
        return;
      }

      stompClient = Stomp.over(sock);

      // 디버그 토글
      stompClient.debug = debugToggle.checked ? (str) => console.debug(str) : null;

      // STOMP Heartbeat 설정 (CONNECT 헤더로 협상됨)
      stompClient.heartbeat.outgoing = outMs;
      stompClient.heartbeat.incoming = inMs;

      stompClient.connect(
        {}, // 인증/토큰 있으면 여기 헤더 추가
        (frame) => {
          const hbHeader = frame && frame.headers ? frame.headers["heart-beat"] : undefined;
          addLog(log, `STOMP 연결 성공 (${url})`, "ok");
          if (hbHeader) addLog(log, `서버 CONNECTED heart-beat: ${hbHeader}`, "muted");
          setConnected(true);
        },
        (err) => {
          addLog(log, `STOMP 연결 실패: ${err}`, "err");
          try { if (sock && typeof sock.close === "function") sock.close(); } catch {}
          setConnected(false);
        }
      );
    });

    // 연결 종료
    btnDisconnect.addEventListener("click", () => {
      try {
        if (subscription) {
          subscription.unsubscribe();
          subscription = null;
        }
        if (stompClient && stompClient.connected) {
          stompClient.disconnect(() => addLog(log, "STOMP 연결 종료", "warn"));
        }
        // SockJS 인스턴스도 정리
        try { if (sock && typeof sock.close === "function") sock.close(); } catch {}
      } catch (e) {
        addLog(log, `연결 종료 중 오류: ${e}`, "err");
      } finally {
        setConnected(false);
      }
    });

    // 구독
    btnSubscribe.addEventListener("click", () => {
      if (!stompClient || !stompClient.connected) {
        addLog(log, "먼저 연결하세요.", "warn");
        return;
      }
      const rid = roomId.value.trim() || "room-1";
      const destination = `/topic/rooms/${rid}`;

      if (subscription) {
        try { subscription.unsubscribe(); } catch {}
        subscription = null;
      }

      subscription = stompClient.subscribe(destination, (frame) => {
        addLog(recv, `수신 @ ${destination} :: ${frame.body}`, "ok");
      });

      addLog(log, `구독 시작: ${destination}`, "ok");
      setConnected(true);
    });

    // 구독 해제
    btnUnsubscribe.addEventListener("click", () => {
      if (!subscription) return;
      try {
        subscription.unsubscribe();
        addLog(log, "구독 해제 완료", "warn");
      } catch (e) {
        addLog(log, `구독 해제 오류: ${e}`, "err");
      } finally {
        subscription = null;
        setConnected(true);
      }
    });

    // 전송
    btnSend.addEventListener("click", () => {
      if (!stompClient || !stompClient.connected) {
        addLog(log, "먼저 연결하고 구독하세요.", "warn");
        return;
      }
      if (!subscription) {
        addLog(log, "구독이 필요합니다.", "warn");
        return;
      }
      const rid = roomId.value.trim() || "room-1";
      const payload = {
        roomId: rid,
        senderId: (senderId.value || "").trim() || "u-123",
        content: (content.value || "").trim() || "hello"
      };

      try {
        stompClient.send("/app/chat.send", {}, JSON.stringify(payload));
        addLog(log, `전송 → /app/chat.send :: ${JSON.stringify(payload)}`);
      } catch (e) {
        addLog(log, `전송 실패: ${e}`, "err");
      }
    });

    // 페이지 이탈 시 정리
    window.addEventListener("beforeunload", () => {
      try { if (subscription) subscription.unsubscribe(); } catch {}
      try { if (stompClient && stompClient.connected) stompClient.disconnect(); } catch {}
      try { if (sock && typeof sock.close === "function") sock.close(); } catch {}
    });
  </script>
</body>
</html>
